<!DOCTYPE html>
<html lang="de">
  <head>
    <link rel="canonical" href="https://deingeschäftskompass.de/blog/Dein-Strategie-Navigator" />
    <script type="text/javascript">
      (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
      j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
      'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
      })(window,document,'script','dataLayer','GTM-WKKNJDLN');
    </script>
    

        
    <title
      >kostenlose Finanz-Simulation & Controlling | Dein Strategie Navigator.
    </title>
    <meta
      name="description"
      content="Optimiere deine Unternehmensstrategie mit unserem Tool. Simuliere Entscheidungen, bewerte Auswirkungen und stärke dein Controlling für effektive Prozessoptimierung."
    />
    <meta
      property="og:title"
      content="kostenlose Finanz-Simulation & Controlling | Dein Strategie Navigator."
    />
    <meta
      property="og:description"
      content="Optimiere deine Unternehmensstrategie mit unserem Tool. Simuliere Entscheidungen, bewerte Auswirkungen und stärke dein Controlling für effektive Prozessoptimierung."
    />
    <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
    />
    <meta charset="utf-8" />
    <meta
      property="twitter:card"
      content="summary_large_image"
    />
    
    <style data-tag="reset-style-sheet">
      html {  line-height: 1.15;}body {  margin: 0;}* {  box-sizing: border-box;  border-width: 0;  border-style: solid;  -webkit-font-smoothing: antialiased;}p,li,ul,pre,div,h1,h2,h3,h4,h5,h6,figure,blockquote,figcaption {  margin: 0;  padding: 0;}button {  background-color: transparent;}button,input,optgroup,select,textarea {  font-family: inherit;  font-size: 100%;  line-height: 1.15;  margin: 0;}button,select {  text-transform: none;}button,[type="button"],[type="reset"],[type="submit"] {  -webkit-appearance: button;  color: inherit;}button::-moz-focus-inner,[type="button"]::-moz-focus-inner,[type="reset"]::-moz-focus-inner,[type="submit"]::-moz-focus-inner {  border-style: none;  padding: 0;}button:-moz-focus,[type="button"]:-moz-focus,[type="reset"]:-moz-focus,[type="submit"]:-moz-focus {  outline: 1px dotted ButtonText;}a {  color: inherit;  text-decoration: inherit;}input {  padding: 2px 4px;}img {  display: block;}details {  display: block;  margin: 0;  padding: 0;}summary::-webkit-details-marker {  display: none;}[data-thq="accordion"] [data-thq="accordion-content"] {  max-height: 0;  overflow: hidden;  transition: max-height 0.3s ease-in-out;  padding: 0;}[data-thq="accordion"] details[data-thq="accordion-trigger"][open] + [data-thq="accordion-content"] {  max-height: 1000vh;}details[data-thq="accordion-trigger"][open] summary [data-thq="accordion-icon"] {  transform: rotate(180deg);}html { scroll-behavior: smooth  }
    </style>
    
    <style data-tag="default-style-sheet">
      html {
        font-family: Inter;
        font-size: 12px;
      }

      body {
        font-weight: 100;
        font-style:normal;
        text-decoration: none;
        text-transform: none;
        letter-spacing: normal;
        line-height: 1.15;
        color: var(--dl-color-theme-neutral-dark);
        background: var(--dl-color-theme-neutral-light);

        fill: var(--dl-color-theme-neutral-dark);
      }
    </style>   

  <!-- Stylesheets -->
  <link rel="stylesheet" href="/style.css" />
  <link rel="stylesheet" href="/impressum.css" />
  <link rel="stylesheet" href="/webfonts.css" />
  <link rel="stylesheet" href="/blog-styles.css" />    
    
      <style>
    .card {
        background-color: #333333; /* Dark card background */
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }

    h2 {
        font-size: 1.5rem; /* text-2xl equivalent */
        font-weight: bold;
        margin-bottom: 1rem;
        color: #ffffff; /* White for readability on dark card */
    }

    h3 {
        font-size: 1.125rem; /* text-lg equivalent */
        font-weight: 500; /* semibold equivalent */

        color: #ffffff; /* White for readability on dark card */
    }

    p {
        color: #e0e0e0; /* Lighter color for general paragraph text for readability */
    }

    /* Input group styling */
    .input-group {
        margin-bottom: 15px;
    }

    .input-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #ffffff; /* White label text as per your input */
    }

    /* Korrigierter Teil in deiner style.css */
    .input-group input[type="number"],
    .input-group input[type="text"],
    .input-group select {
        width: 100%; /* Nimmt die volle Breite des Elternelements ein */
        max-width: 300px; /* Begrenzt die maximale Breite, damit es nicht zu breit wird */
        padding: 10px;
        border: 1px solid #333333; /* Border as per your input */
        background-color: #d1d1d1; /* Background as per your input */
        border-radius: 4px;
        font-size: 1rem;
        color: #333333; /* Ensures input text is dark and readable on light input background */
    }

    .input-group input[type="text"]:focus,
    .input-group input[type="number"]:focus {
        outline: none; /* Remove default focus outline */
        box-shadow: 0 0 0 3px rgba(0, 140, 186, 0.5); /* Blue focus outline matching your brand blue */
    }

    /* Flex container for sections */
    .sections-container {
        display: flex;
        flex-direction: column; /* Default to column on small screens */
        gap: 2rem; /* Abstand zwischen den Sektionen */
        padding: 1rem; /* Innenabstand */
        justify-content: center;
        align-items: flex-start;
    }

    @media (min-width: 768px) { /* md breakpoint */
        .sections-container {
            flex-direction: row; /* Row on medium screens and up */
            gap: 3rem; /* Größerer Abstand auf Desktop */
            padding: 2rem;
        }
        .sections-container > section {
            width: 50%; /* Jede Sektion nimmt die Hälfte der Breite ein */
        }
    }

    /* Specific Button Colors based on your original request */
    #calculate-baseline {
        color: #008cbaff; /* Your brand blue */
        border-color: #008cbaff; /* Your brand blue */
    }

    #calculate-baseline:hover {
        background-color: #008cbaff; /* Fill with your brand blue on hover */
        color: #333333; /* Dark text for contrast on hover */
        border-color: transparent;
    }

    .summary-box {
        background-color: #105a7a; /* As per your input */
        border: 1px solid #333333; /* As per your input */
        border-radius: 5px;
        padding: 15px;
        margin-top: 20px;
        color: #fffefe; /* As per your input */
    }

    .scenario-category {
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px dashed #eee; /* As per your input */
    }

    .scenario-category label {
        display: block;
        margin-bottom: 8px;
        cursor: pointer;
        color: #ffffff; /* White for readability on dark background */
    }

    .scenario-category input[type="checkbox"] {
        margin-right: 10px;
    }

    #scenario-inputs-container {
        margin-top: 20px;
        padding: 15px;
        border: 1px dashed #333333; /* As per your input */
        border-radius: 5px;
        background-color: #333333; /* As per your input */
        color: #e0e0e0; /* Lighter text for readability */
    }

    .scenario-input-group {
        background-color: #333333; /* As per your input */
        padding: 15px;
        border: 1px solid #333333; /* As per your input */
        border-radius: 5px;
        margin-bottom: 15px;
        color: #e0e0e0; /* Lighter text for readability */
    }

    .scenario-input-group h4 {
        margin-top: 0;
        color: #008cbaff; /* As per your input */
        font-size: 1.1em;
    }

    #pnl-comparison-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background-color: #333333;
    }

    #pnl-comparison-table th,
    #pnl-comparison-table td {
        border: 1px solid #333333; /* As per your input */
        padding: 10px;
        text-align: left;
        color: #ffffff; /* White text for readability on dark table cells */
        background-color: #333333;
    }

    #pnl-comparison-table th {
        background-color: #333333; /* As per your input */
        font-weight: bold; /* As per your input */
        color: #008cbaff; /* Blue text as per your original table header style */
        text-decoration: underline; /* Underline as per your original table header style */
    }

    #pnl-comparison-table tbody tr {
        background-color: #333333; /* As per your input */
    }

    #pnl-comparison-table .positive {
        color: #28a745; /* As per your input */
        font-weight: bold;
    }

    #pnl-comparison-table .negative {
        color: #dc3545; /* As per your input */
        font-weight: bold;
    }

    /* New styles for cost items within the P&L table */
    #pnl-comparison-table .cost-item .positive {
        color: #dc3545; /* As per your input */
    }

    #pnl-comparison-table .cost-item .negative {
        color: #28a745; /* As per your input */
    }
    .hidden {
        display: none;
    }

    /* Angepasster Teil in deiner style.css */
    .chart-box {
        background-color: #333333; /* As per your input */
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        position: relative;
        width: 100%;
        max-width: 800px;
        height: 400px;
        margin-left: auto;
        margin-right: auto;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    /* Standard-Stile für die Überschrift */
    .chart-box h3 {
        /* Standard-Stile, z.B. keine Rotation */
        font-size: 1.5em;
        text-align: center;
    }

    /* Media Query für mobile Geräte (z.B. Bildschirme bis 768px Breite) */
    @media (max-width: 768px) {
        .chart-box h3 {
            /* Hier werden die Stile nur auf mobilen Geräten angewendet */
            transform: rotate(-90deg); /* Dreht die Überschrift um 90 Grad im Uhrzeigersinn */
            flex-shrink: 0;
            white-space: nowrap; /* Verhindert Zeilenumbruch */
            transform-origin: center center; /* Standardmäßig um die Mitte drehen */
            font-size: 0.9em;
        }
    }

    .chart-box canvas {
        width: 100% !important;
        height: 100% !important;
        display: block;
    }

    #reset-simulation {
        background-color: #333333; /* As per your input */
        margin-top: 30px;
    }

    #reset-simulation:hover {
        background-color: #5a6268; /* As per your input */
    }

    /* Specific styling for the Long-Term Scaling table (if used for numbers) */
    #long-term-scaling-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }

    #long-term-scaling-table th,
    #long-term-scaling-table td {
        border: 1px solid #ddd; /* As per your input */
        padding: 8px;
        text-align: right; /* Financial numbers usually right-aligned */
        color: #ffffff; /* White text for readability */
    }

    #long-term-scaling-table th {
        background-color: #333333; /* As per your input */
        font-weight: bold;
        text-align: center;
    }
      </style>  
  </div>
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript>
    <iframe 
      src="https://www.googletagmanager.com/ns.html?id=GTM-WKKNJDLN"
      height="0" 
      width="0" 
      style="display:none;visibility:hidden">
    </iframe>
  </noscript>

    <div
        class="mehr-erfahren-container1"
    >
        <header class="mehr-erfahren-container2"></header>
        <kopfzeile-rest-wrapper
            class="kopfzeile-rest-wrapper"
            rootclassname="kopfzeile-restundefined"
        >
            <header
                class="kopfzeile-rest-container kopfzeile-restroot-class-name"
            >
                <header
                    data-thq="thq-navbar"
                    class="kopfzeile-rest-navbar-interactive"
                >
                    <a href="/index.html" class="kopfzeile-rest-navlink">
                        <img
                            alt="Dein Geschäftskompass – zurück zur Startseite."
                            src="/public/Logo48.webp"
                            class="kopfzeile-rest-image1"
                            width="36"  height="36"
                        />
                    </a>
                    <div
                        data-thq="thq-navbar-nav"
                        class="kopfzeile-rest-desktop-menu"
                    >
                        <nav class="kopfzeile-rest-links">
                            <a
                                href="/index.html"
                                class="kopfzeile-rest-link1 thq-body-small thq-link"
                            >
                                <fragment class="mehr-erfahren-fragment10">
                                    <span class="mehr-erfahren-text100">Startseite</span>
                                </fragment>
                            </a>

                          <div class="kopfzeile-start-buttons">
                              <a
                                  href="/Gut-zu-Wissen.html"
                                  class="kopfzeile-rest-action2 thq-button-animated thq-button-outline"
                              >
                                  <span>
                                      <fragment class="startseite-fragment17">
                                          <span class="startseite-text107">Gut zu Wissen</span>
                                      </fragment>
                                  </span>
                              </a>
                          </div>

                          <div class="kopfzeile-start-buttons">
                              <a
                                  href="/Verantwortung.html"
                                  class="kopfzeile-rest-action2 thq-button-animated thq-button-outline"
                              >
                                  <span>
                                      <fragment class="startseite-fragment17">
                                          <span class="startseite-text107">Verantwortung</span>
                                      </fragment>
                                  </span>
                              </a>
                          </div>
                          
                          <div class="kopfzeile-start-buttons">
                            <a
                                href="/Preise.html"
                                class="kopfzeile-rest-action2 thq-button-animated thq-button-outline"
                            >
                                <span>
                                    <fragment class="startseite-fragment17">
                                        <span class="startseite-text107">Preise</span>
                                    </fragment>
                                </span>
                            </a>
                          </div>
                            
                        </nav>
                        <div class="kopfzeile-rest-buttons">
                            <a
                                href="/mehr-erfahren.html"
                                class="kopfzeile-rest-action1 thq-button-filled thq-button-animated"
                            >
                                <span>
                                    <fragment class="mehr-erfahren-fragment11">
                                        <span class="mehr-erfahren-text101">mehr Erfahren</span>
                                    </fragment>
                                </span>
                            </a>
                            <a
                                href="/kontakt.html"
                                class="kopfzeile-rest-action1 thq-button-filled thq-button-animated"
                            >
                                <span>
                                    <fragment class="mehr-erfahren-fragment12">
                                        <span class="mehr-erfahren-text102">Kontakt</span>
                                    </fragment>
                                </span>
                            </a>
                        </div>
                    </div>
                    <div
                        data-thq="thq-burger-menu"
                        class="kopfzeile-rest-burger-menu"
                        onclick="toggleMobileMenuRest()"
                    >
                        <div></div>
                        <div></div>
                        <div></div>
                    </div>
                    <div
                        data-thq="thq-mobile-menu"
                        class="kopfzeile-rest-mobile-menu"
                        id="mobileMenuRest"
                    >
                        <a href="/index.html">Startseite</a>
                        <a href="/gut-zu-wissen.html">Gut zu Wissen</a>
                        <a href="/Verantwortung.html">Verantwortung</a>
                        <a href="/preise.html">Preise</a>
                        <a href="/mehr-erfahren.html">Mehr Erfahren</a>
                        <a href="/kontakt.html">Kontakt</a>
                    </div>
                </header>
            </header>
        </kopfzeile-rest-wrapper>
      
<!--Neuer component-->
    <header>
        <h1 class="impressum-text-heading2 thq-heading-1">
        <fragment class="impressum-fragment3">
            <span class="impressum-text12">Dein Startegie Navigator</span>
        </fragment>
        </h1>

        <p class="thq-body-small">Simuliere deine strategische Entscheidungen und bewerte die Auswirkungen deiner Erfolgsrechnung.</p>
    </header>

    <main>
        <div class="sections-container">
            <section id="baseline-input" class="card">
                <h2>1. Aktuelle Jahres-Ist-Werte</h2>
                <form id="baseline-form">
                    <div class="input-group">
                        <label for="umsatz_ist">Umsatz (pro Jahr) €</label>
                        <input type="text" id="umsatz_ist" value="1.000.000" min="0" required inputmode="numeric">
                    </div>
                    <div class="input-group">
                        <label for="wareneinsatz_ist">Wareneinsatz / Materialaufwand (pro Jahr) €</label>
                        <input type="text" id="wareneinsatz_ist" value="400.000" min="0" required inputmode="numeric">
                    </div>
                    <div class="input-group">
                        <label for="current_employees">Aktuelle Anzahl Mitarbeiter</label>
                        <input type="number" id="current_employees" value="10" min="0" required>
                    </div>
                    <div class="input-group">
                        <label for="personalkosten_ist">Personalkosten (pro Jahr) €</label>
                        <input type="text" id="personalkosten_ist" value="200.000" min="0" required inputmode="numeric">
                    </div>
                    <div class="input-group">
                        <label for="raumkosten_ist">Raumkosten (pro Jahr) €</label>
                        <input type="text" id="raumkosten_ist" value="50.000" min="0" required inputmode="numeric">
                    </div>
                    <div class="input-group">
                        <label for="werbekosten_ist">Werbekosten (pro Jahr) €</label>
                        <input type="text" id="werbekosten_ist" value="30.000" min="0" required inputmode="numeric">
                    </div>
                    <div class="input-group">
                        <label for="sonstige_betriebliche_aufwendungen_ist">Sonstige Betriebliche Aufwendungen (pro Jahr) €</label>
                        <input type="text" id="sonstige_betriebliche_aufwendungen_ist" value="20.000" min="0" required inputmode="numeric">
                    </div>
                    <div class="input-group">
                        <label for="abschreibungen_ist">Jährliche Abschreibungen €</label>
                        <input type="text" id="abschreibungen_ist" value="10.000" min="0" required inputmode="numeric">
                    </div>
                    <div class="input-group">
                        <label for="finanzierungskosten_ist">Jährliche Finanzierungskosten / Zinsaufwand €</label>
                        <input type="text" id="finanzierungskosten_ist" value="5.000" min="0" required inputmode="numeric">
                    </div>
                    <div class="input-group">
                        <label for="ertragsteuersatz_ist">Durchschnittlicher Ertragsteuersatz (%)</label>
                        <input type="number" id="ertragsteuersatz_ist" value="25" min="0" max="100" step="0.1" required>
                    </div>
                    <button
                        type="button"
                        id="calculate-baseline"
                        class="kopfzeile-rest-action2 thq-button-animated thq-button-outline">
                        <span>Baseline berechnen</span>
                    </button>
                </form>
                <div id="baseline-pnl-summary" class="summary-box"></div>
            </section>

            <section id="scenario-selection" class="card">
                <h2>2. Szenarien auswählen und simulieren</h2>
                <p class="mb-4 text-gray-700">Wähle ein oder mehrere Szenarien aus, um deren Auswirkungen zu simulieren.</p>

                <div class="scenario-category">
                    <h3>A. Wachstum & Umsatztreiber</h3>
                    <label class="block mb-1"><input type="checkbox" data-scenario="price_adjustment" class="mr-2"> Preise anpassen & Wirkung auf Profitabilität prüfen</label>
                    <label class="block mb-1"><input type="checkbox" data-scenario="new_product" class="mr-2"> Neues Produkt / Dienstleistung einführen & Wirtschaftlichkeit bewerten</label>
                    <label class="block"><input type="checkbox" data-scenario="marketing_investment" class="mr-2"> Marketinginvestitionen planen & deren Effekt simulieren</label>
                </div>

                <div class="scenario-category">
                    <h3>B. Personalmanagement</h3>
                    <label class="block mb-1"><input type="checkbox" data-scenario="new_employee" class="mr-2"> Neuen Mitarbeiter einstellen & Finanzierung planen</label>
                    <label class="block"><input type="checkbox" data-scenario="growth_personnel" class="mr-2"> Personalbedarf bei Wachstum ermitteln</label>
                </div>

                <div class="scenario-category">
                    <h3>C. Investitionen & Assets</h3>
                    <label class="block mb-1"><input type="checkbox" data-scenario="new_machine" class="mr-2"> Neue Maschine / Betriebsausstattung planen & Auswirkungen simulieren</label>
                    <label class="block mb-1"><input type="checkbox" data-scenario="new_vehicle" class="mr-2"> Neues Fahrzeug (KFZ) anschaffen & Auswirkungen simulieren</label>
                    <label class="block"><input type="checkbox" data-scenario="it_infrastructure" class="mr-2"> IT-Infrastruktur / Softwarelizenzen investieren & Effekte prüfen</label>
                </div>

                <div class="scenario-category">
                    <h3>D. Kosten & Effizienz</h3>
                    <label class="block"><input type="checkbox" data-scenario="cost_optimization" class="mr-2"> Kosten optimieren & Gewinn steigern</label>
                </div>

                <div class="scenario-category">
                    <h3>E. Risiko & Strategische Planung</h3>
                    <label class="block mb-1"><input type="checkbox" data-scenario="revenue_decline" class="mr-2"> Umsatzeinbruch / Kundenverlust simulieren & Auswirkung prüfen</label>
                    <label class="block"><input type="checkbox" data-scenario="long_term_scaling" class="mr-2"> Langfristige Business-Skalierung über mehrere Jahre visualisieren</label>
                </div>

                <div id="scenario-inputs-container" class="mt-4">
                    <!-- Dynamically loaded scenario inputs will appear here -->
                </div>
                <button
                    type="button"
                    class="kopfzeile-rest-action2 thq-button-animated thq-button-outline"
                    id="calculate-scenario">Szenario(s) simulieren</button>
            </section>
        </div>

        <section id="results-output" class="card hidden mx-4 md:mx-8 mt-8">
            <h2>3. Simulationsergebnisse*</h2>
            <div class="-sectiresulton">
                <h3>P&L Vergleich (Ist vs. Neu)</h3>
                <table id="pnl-comparison-table">
                    <thead>
                        <tr>
                            <th>Posten</th>
                            <th>Ist-Werte (€)</th>
                            <th>Neue Werte (€)</th>
                            <th>Veränderung (€)</th>
                            <th>Veränderung (%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Table rows will be inserted here by JavaScript -->
                    </tbody>
                </table>
            </div>

            <div class="result-section">
                <div id="key-metrics-summary" class="summary-box"></div>
            </div><br /><br /><br />

            <p class="preise-text38 thq-body-large" style="text-align: left; font-style: italic; color:#ffffff; font-weight:800;">
                Hast du Fragen zu den Ergebnissen oder möchtest du tiefer in die Details deiner Finanzplanung eintauchen?<br />
                Wir helfen dir gerne weiter, um deine Simulation noch präziser zu gestalten!. Nimm gerne Kontakt zu uns aus.<br />
            </p>
            <a
                href="/kontakt.html"
                class="kopfzeile-rest-action1 thq-button-filled thq-button-animated">
                    <span>
                        <fragment class="mehr-erfahren-fragment12">
                            <span class="mehr-erfahren-text102">Jetzt unverbindlich Kontakt aufnehmen</span>
                        </fragment>
                    </span>
            </a>

            <div id="chart-container">
                <div class="chart-box hidden" id="umsatz-chart-box">
                    <h3>Umsatzentwicklung</h3>
                    <canvas id="umsatzChart"></canvas>
                </div>
                <div class="chart-box hidden" id="gewinn-chart-box">
                    <h3>Gewinnentwicklung</h3>
                    <canvas id="gewinnChart"></canvas>
                </div>
                <div class="chart-box hidden" id="cost-structure-chart-box" style="height: 500px;">
                    <h3>Kostenstruktur im Vergleich</h3>
                    <canvas id="costStructureChart"></canvas>
                </div>
                <div class="chart-box hidden" id="long-term-scaling-chart-box">
                    <h3>Langfristige Skalierung</h3>
                    <canvas id="longTermScalingChart"></canvas>
                </div>
                <div id="goal-seeking-output" class="summary-box hidden">
                    <h3>Ziel-Outputs</h3>
                    <p id="needed-revenue-output"></p>
                </div>                
            </div>


            <br />
            <p class="thq-body-small">
                Du fragst dich wer hinter Dein Startegie Navigator steckt und möchtest weitere Tools entdecken, dann erfahre mehr Über Uns.<br />
            </p>
            <a
                href="/mehr-erfahren.html"
                class="kopfzeile-rest-action2 thq-button-animated thq-button-outline"
            >
                <span>
                    <fragment class="mehr-erfahren-fragment12">
                        <span class="mehr-erfahren-text102">Jetzt mehr Erfahren</span>
                    </fragment>
                </span>
            </a>
            <br />            
            <p class="thq-body-small">
                Oder starte eine neue Simulation:<br />
            </p>
            <button 
                type="button"
                class="kopfzeile-rest-action2 thq-button-animated thq-button-outline"
                id="reset-simulation">Neue Simulation starten
            </button>
            <br />
            <p>
                *Wichtiger Hinweis zu den Simulationsergebnissen:
                Bitte beachte, dass alle Ergebnisse, die dieses Tool generiert, 
                ohne Gewähr sind und ausschließlich auf den von dir eingegebenen Werten für eine vereinfachte Simulation basieren. 
                Diese Berechnungen sollen dir ein grundlegendes Verständnis potenzieller finanzieller Auswirkungen unter bestimmten Annahmen vermitteln 
                und stellen keine Finanz-, Steuer- oder Rechtsberatung dar.
                Für eine umfassende und präzise Finanzanalyse ist es entscheidend, dass du Faktoren berücksichtigst, die über diese Simulation hinausgehen. 
                Dazu gehören unter anderem:
                1. Liquidität: Diese Simulation berücksichtigt weder deinen tatsächlichen Cashflow noch die Liquiditätsbedürfnisse, 
                die für deinen Geschäftsbetrieb von entscheidender Bedeutung sind.
                2. Individuelle Gegebenheiten: Deine spezifische Unternehmensstruktur, Rechtsform, Steuersituation, bestehende Verträge 
                und andere einzigartige betriebliche Details können deine finanzielle Performance erheblich beeinflussen.
                3. Marktdynamik: Externe Marktbedingungen, unvorhergesehene Ereignisse und Änderungen im Wirtschaftsklima werden von diesem vereinfachten Modell nicht vollständig erfasst.
            </p>
        </section>
    </main>           

        <fuzeile-wrapper class="fuzeile-wrapper">
            <div class="thq-divider-horizontal"></div> <footer class="fuzeile-footer7 thq-section-padding">
              <div class="fuzeile-max-width thq-section-max-width">
                <div class="fuzeile-content">

                  <div class="fuzeile-social-buttons">
                    Folge Uns auf: 
                    <a href="#" onclick="window.open(getShareUrl('instagram'), '_blank'); return false;" class="fuzeile-social-button">
                      <img src="/public/instagram.webp" alt="Instagram" class="fuzeile-social-icon"/>
                    </a>
                    - oder teile deine Begeisterung auf:                    
                    <a href="#" onclick="window.open(getShareUrl('facebook'), '_blank'); return false;" class="fuzeile-social-button">
                      <img src="/public/facebook.webp" alt="Facebook" class="fuzeile-social-icon"/>
                    </a>
                    <a href="#" onclick="window.open(getShareUrl('reddit'), '_blank'); return false;" class="fuzeile-social-button">
                      <img src="/public/reddit.webp" alt="Reddit" class="fuzeile-social-icon"/>
                    </a>
                    <a href="#" onclick="window.open(getShareUrl('whatsapp'), '_blank'); return false;" class="fuzeile-social-button">
                      <img src="/public/whatsapp.webp" alt="WhatsApp" class="fuzeile-social-icon"/>
                    </a>
                    <a href="#" onclick="window.open(getShareUrl('tumblr'), '_blank'); return false;" class="fuzeile-social-button">
                      <img src="/public/tumblr.webp" alt="Tumblr" class="fuzeile-social-icon"/>
                    </a> 
                    <a href="#" onclick="window.open(getShareUrl('wordpress'), '_blank'); return false;" class="fuzeile-social-button">
                      <img src="/public/wordpress.webp" alt="WordPress" class="fuzeile-social-icon"/>
                    </a>
                    <button class="fuzeile-share-button" onclick="sharePage()">
                      <img src="/public/share.webp" alt="Teilen" class="fuzeile-social-icon"/>
                    </button>
                  </div>
                </div>

                <div class="fuzeile-credits">
                  <div class="fuzeile-row">
                    <div class="fuzeile-container">
                      </div>
                    <div class="fuzeile-footer-links">
                      <span class="thq-link">
                        <fragment class="impressum-fragment7">
                          <a href="/Gut-zu-Wissen.html" class="thq-link">
                            <span class="startseite-text269">Blog</span>
                          </a>
                        </fragment>
                      </span>
                      <span class="thq-link">
                        <fragment class="impressum-fragment7">
                          <a href="Tools.html" class="thq-link">
                            <span class="startseite-text269">Tools</span>
                          </a>
                        </fragment>
                      </span>
                      <span class=" thq-link">
                        <fragment class="impressum-fragment7">
                          <a href="/Widerrufsrecht.html" class=" thq-link">
                            <span class="startseite-text269">Widerrufsrecht</span>
                          </a>
                        </fragment>
                      </span>
                      <span class=" thq-link">
                        <fragment class="impressum-fragment7">
                          <a href="/datenschutz.html" class=" thq-link">
                            <span class="startseite-text269">Datenschutz</span>
                          </a>
                        </fragment>
                      </span>
                      <span class="thq-link">
                        <fragment class="impressum-fragment7">
                          <a href="/impressum.html" class="thq-link">
                            <span class="startseite-text268">Impressum</span>
                          </a>
                        </fragment>
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </footer>
          </fuzeile-wrapper>
        </div>

      <script>
      // Funktion zum Generieren der plattformspezifischen Share-URLs
      function getShareUrl(platform) {
        const url = encodeURIComponent(window.location.href);
        const title = encodeURIComponent(document.title);
        // Versuche, die Meta-Description zu bekommen, sonst leer
        const description = encodeURIComponent(document.querySelector('meta[name="description"]')?.content || '');

        switch (platform) {

          case 'facebook':
            // Facebook Share URL: u= für die zu teilende URL
            return `https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${title}`;
          case 'reddit':
            // Reddit Share URL: url und title
            return `https://www.reddit.com/submit?url=${url}&title=${title}`;
          case 'whatsapp':
            // WhatsApp Share URL: text (Titel + URL)
            return `https://wa.me/?text=${title}%20${url}`;
          case 'tumblr':
            // Tumblr Share URL: posttype=link, title und content
            // Du kannst auch posttype=quote oder posttype=text verwenden
            return `https://www.tumblr.com/widgets/share/tool?posttype=link&canonicalUrl=${url}&title=${title}&content=${description}`;
          case 'instagram':
            return `https://www.instagram.com/deingeschaeftskompass/`;
          case 'wordpress':
            // WordPress.com Share URL: link und title
            return `https://wordpress.com/create/post?url=${url}&title=${title}`;
          default:
            console.warn("Unbekannte Plattform für Teilen-URL:", platform);
            return '#'; // Fallback
        }
      }

      // Funktion für den allgemeinen Teilen-Button (nutzt native Browser-API)
      function sharePage() {
        if (navigator.share) {
          // Wenn der Browser die native Share-API unterstützt
          navigator.share({
            title: document.title,
            text: 'Schau dir diese Seite an: ' + document.title,
            url: window.location.href,
          })
          .then(() => console.log('Erfolgreich geteilt!'))
          .catch((error) => console.log('Fehler beim Teilen:', error));
        } else {
          // Fallback für Browser, die die native Share-API nicht unterstützen
          alert('Ihr Browser unterstützt die native Share-Funktion nicht direkt. Bitte kopiere den Link manuell: ' + window.location.href);

        }
      }
      </script>

    <script>
      function toggleMobileMenuRest() {
          const mobileMenu = document.getElementById('mobileMenuRest');
          const mainContent = document.getElementById('mainContent');
          mobileMenu.classList.toggle('open');

          if (mobileMenu.classList.contains('open')) {
              mainContent.style.marginTop = 'auto'; 
          } else {
              mainContent.style.marginTop = '0';
          }
      }
  </script>


    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

<script>
// -----------------------------------------------------------
// 1. Global Variables & Initial Setup
// -----------------------------------------------------------

let baselinePnl = {};
let scenarioPnl = {};
let activeScenarios = new Set(); // Stores which scenarios are currently active

// Globale Variablen für Chart-Instanzen
let myCharts = {
    umsatzChartInstance: null,
    gewinnChartInstance: null,
    costStructureChartInstance: null,
    longTermScalingChartInstance: null
};

// P&L line items for display and calculation
const pnlLineItems = [
    { id: 'umsatz', label: 'Umsatz' },
    { id: 'wareneinsatz', label: 'Wareneinsatz / Materialaufwand' },
    { id: 'rohertrag', label: 'Rohertrag' },
    { id: 'personalkosten', label: 'Personalkosten' },
    { id: 'raumkosten', label: 'Raumkosten' },
    { id: 'werbekosten', label: 'Werbekosten' },
    { id: 'sonstige_betriebliche_aufwendungen', label: 'Sonstige Betriebliche Aufwendungen' },
    { id: 'abschreibungen', label: 'Abschreibungen' },
    { id: 'finanzierungskosten', label: 'Finanzierungskosten (Zinsen)' },
    { id: 'ebt', label: 'Ergebnis vor Steuern (EBT)' },
    { id: 'ertragsteuern', label: 'Ertragsteuern' },
    { id: 'ergebnis_nach_steuern', label: 'Ergebnis nach Steuern' }
];

// Default employer social costs for new employees (can be adjusted)
const EMPLOYER_SOCIAL_COSTS_PERCENT = 0.22; // 22%

// -----------------------------------------------------------
// 2. Helper Functions (AKTUALISIERT MIT NEUEN FUNKTIONEN)
// -----------------------------------------------------------

// Formats a number as currency (€) - Diese ist für den OUTPUT (SUMMARY)
function formatCurrency(value) {
    return new Intl.NumberFormat('de-DE', { style: 'currency', currency: 'EUR' }).format(value);
}

// Formats a number as percentage
function formatPercentage(value) {
    return new Intl.NumberFormat('de-DE', { style: 'percent', minimumFractionDigits: 1, maximumFractionDigits: 2 }).format(value / 100);
}

// Formats a number with thousands separator (e.g., 1.000.000) - FÜR DIE INPUT-FELDER ANZEIGE
function formatNumberForInput(value) {
    // Zuerst alle Nicht-Zahlen und das Komma entfernen (falls als Dezimaltrennzeichen eingegeben)
    let cleanValue = String(value).replace(/[^0-9,-]/g, ''); // Erlaubt nur Zahlen, Komma, Minus
    cleanValue = cleanValue.replace(',', '.'); // Komma zu Punkt für parseFloat

    // parseFloat, um sicherzustellen, dass es eine Zahl ist, dann formatieren
    const num = parseFloat(cleanValue);
    if (isNaN(num)) {
        return ''; // Wenn es keine gültige Zahl ist, leeren String zurückgeben
    }
    // Formatieren ohne Währungssymbol, nur mit Tausendertrennzeichen (Standard de-DE ist Punkt)
    return new Intl.NumberFormat('de-DE').format(num);
}

// Helper to remove formatting for calculations - VOR BERECHNUNGEN VERWENDEN
function cleanNumberForCalculation(formattedValue) {
    // Entfernt Tausendertrennzeichen (Punkte) und ersetzt das Komma durch einen Punkt für Dezimalzahlen
    let cleaned = String(formattedValue).replace(/\./g, ''); // Entfernt Tausender-Punkte
    cleaned = cleaned.replace(/,/g, '.'); // Ersetzt Komma als Dezimaltrennzeichen durch Punkt
    return parseFloat(cleaned);
}


// Calculates P&L derived values (Rohertrag, EBT, Steuern, Ergebnis nach Steuern)
function calculateDerivedPnl(pnlData, taxRate) {
    pnlData.rohertrag = pnlData.umsatz - pnlData.wareneinsatz;
    pnlData.ebt = pnlData.rohertrag - pnlData.personalkosten - pnlData.raumkosten -
                  pnlData.werbekosten - pnlData.sonstige_betriebliche_aufwendungen -
                  pnlData.abschreibungen - pnlData.finanzierungskosten;
    pnlData.ertragsteuern = pnlData.ebt > 0 ? pnlData.ebt * (taxRate / 100) : 0;
    pnlData.ergebnis_nach_steuern = pnlData.ebt - pnlData.ertragsteuern;
    return pnlData;
}

// This is a conceptual function. You need to fill in the specifics based on how your costs are structured.

function calculateBreakEvenData(pnlData, maxUmsatz) {
    // --- Step 1: Identify Fixed and Variable Costs ---
    // This is simplified. You might need to refine how you split costs.
    const fixedCosts = pnlData.raumkosten + pnlData.abschreibungen + pnlData.finanzierungskosten +
                       (pnlData.personalkosten * 0.7) + // Assuming 70% of personnel costs are fixed
                       (pnlData.sonstige_betriebliche_aufwendungen * 0.5); // Assuming 50% are fixed

    const variableCostsRate = (pnlData.wareneinsatz +
                               (pnlData.personalkosten * 0.3) + // Remaining 30% of personnel costs are variable
                               (pnlData.sonstige_betriebliche_aufwendungen * 0.5)) // Remaining 50% are variable
                               / pnlData.umsatz; // Variable cost per unit of Umsatz

    // --- Step 2: Define the plotting range (e.g., 0 to 120% of maxUmsatz) ---
    const dataPoints = 20; // Number of points to plot for smoother lines
    const labels = [];
    const revenueData = [];
    const fixedCostData = [];
    const totalCostData = [];

    for (let i = 0; i <= dataPoints; i++) {
        const currentUmsatz = (maxUmsatz / dataPoints) * i;
        labels.push(formatCurrency(currentUmsatz)); // Label for the X-axis (Umsatz)

        const currentVariableCosts = currentUmsatz * variableCostsRate;
        const currentTotalCosts = fixedCosts + currentVariableCosts;

        revenueData.push(currentUmsatz);
        fixedCostData.push(fixedCosts);
        totalCostData.push(currentTotalCosts);
    }

    return {
        labels: labels,
        revenue: revenueData,
        fixedCosts: fixedCostData,
        totalCosts: totalCostData,
        fixedCostsValue: fixedCosts, // Return actual fixed cost for BEP calculation
        variableCostsRateValue: variableCostsRate // Return actual variable cost rate for BEP calculation
    };
}

// You'll also need a function to calculate the Break-Even Point in terms of Umsatz
function calculateBreakEvenPointUmsatz(fixedCosts, variableCostsRate) {
    if (1 - variableCostsRate === 0) return Infinity; // Avoid division by zero
    return fixedCosts / (1 - variableCostsRate);
}

// This function will need to be defined somewhere accessible in your code
// function formatCurrency(value) { /* ... your existing implementation ... */ }

function destroyCharts() {
    console.log("destroyCharts START");
    if (myCharts.umsatzChartInstance) {
        myCharts.umsatzChartInstance.destroy();
        myCharts.umsatzChartInstance = null;
        console.log("umsatzChartInstance zerstört.");
    }
    if (myCharts.gewinnChartInstance) {
        myCharts.gewinnChartInstance.destroy();
        myCharts.gewinnChartInstance = null;
        console.log("gewinnChartInstance zerstört.");
    }
    if (myCharts.costStructureChartInstance) {
        myCharts.costStructureChartInstance.destroy();
        myCharts.costStructureChartInstance = null;
        console.log("costStructureChartInstance zerstört.");
    }
    if (myCharts.longTermScalingChartInstance) {
        myCharts.longTermScalingChartInstance.destroy();
        myCharts.longTermScalingChartInstance = null;
        console.log("longTermScalingChartInstance zerstört.");
    }
    console.log("destroyCharts END");
}

// Hides all chart containers by default
function hideAllChartContainers() {
    document.querySelectorAll('.chart-box').forEach(box => box.classList.add('hidden'));
    document.getElementById('goal-seeking-output').classList.add('hidden');
}

// -----------------------------------------------------------
// 3. Baseline Calculation & Display (AKTUALISIERT)
// -----------------------------------------------------------

// Fügt Event Listener hinzu und initialisiert die Input-Feld Formatierung
document.addEventListener('DOMContentLoaded', function() {
    const inputFieldsToFormat = [
        'umsatz_ist',
        'wareneinsatz_ist',
        'personalkosten_ist',
        'raumkosten_ist',
        'werbekosten_ist',
        'sonstige_betriebliche_aufwendungen_ist',
        'abschreibungen_ist',
        'finanzierungskosten_ist',
        // Hinzufügen der Szenario-spezifischen Gehaltsfelder für Formatierung
        'gp_monthly_salary', // For "Personalbedarf bei Wachstum ermitteln"
        'ne_monthly_salary'  // For "Neuen Mitarbeiter einstellen"
    ];

    inputFieldsToFormat.forEach(id => {
        const inputElement = document.getElementById(id);
        if (inputElement) {
            // Formatiere den initialen Wert beim Laden der Seite
            inputElement.value = formatNumberForInput(inputElement.value);

            // Füge Event Listener für die Formatierung beim Verlassen des Feldes hinzu
            inputElement.addEventListener('blur', (event) => {
                event.target.value = formatNumberForInput(event.target.value);
                // Trigger the relevant calculation after formatting on blur
                if (id === 'gp_monthly_salary') calculateGrowthPersonnel();
                if (id === 'ne_monthly_salary') calculateNewEmployeeCost();
            });
            // Füge Event Listener für 'input' bei jedem Tastendruck hinzu, falls eine 'Live-Berechnung' gewünscht ist
            inputElement.addEventListener('input', (event) => {
                // We don't format on 'input' for number inputs to allow free typing
                // but we do trigger calculations if these are scenario inputs
                if (id === 'gp_monthly_salary') calculateGrowthPersonnel();
                if (id === 'ne_monthly_salary') calculateNewEmployeeCost();
            });
        }
    });

    // Event Listener für das Feld 'current_employees'
    const currentEmployeesInput = document.getElementById('current_employees');
    if (currentEmployeesInput) {
        currentEmployeesInput.addEventListener('input', calculateGrowthPersonnel); // Triggert die Wachstumspersonal-Berechnung bei Änderung
        // Da es ein type="number" ist, ist keine `formatNumberForInput` Initialisierung oder blur-Formatierung nötig.
    }


    // Event Listener für den Berechnen-Button
    document.getElementById('calculate-baseline').addEventListener('click', function() {
        calculateAndDisplayBaseline();
        applyCostItemStyling(); // Call styling after calculation
        // Trigger die Szenario-Berechnungen nach dem Aktualisieren der Baseline
        calculateGrowthPersonnel();
        calculateNewEmployeeCost();
    });

    // --- Cost Item Styling Logic (No changes needed here) ---
    const pnlTableBody = document.querySelector('#pnl-comparison-table tbody');
    const costItems = [
        "Wareneinsatz / Materialaufwand",
        "Personalkosten",
        "Raumkosten",
        "Werbekosten",
        "Sonstige Betriebliche Aufwendungen",
        "Jährliche Abschreibungen",
        "Jährliche Finanzierungskosten / Zinsaufwand"
    ];

    function applyCostItemStyling() {
        console.log("applyCostItemStyling called!");
        if (!pnlTableBody) {
            console.error("Error: #pnl-comparison-table tbody not found.");
            return;
        }
        const rows = pnlTableBody.querySelectorAll('tr');
        rows.forEach(row => {
            const firstCell = row.querySelector('td:first-child');
            if (firstCell) {
                const itemText = firstCell.textContent.trim();
                const isCostItem = costItems.some(costItem => itemText.startsWith(costItem));
                if (isCostItem) {
                    row.classList.add('cost-item');
                } else {
                    row.classList.remove('cost-item');
                }
            }
        });
    }

    // Initialberechnung beim Laden der Seite, um die Summary mit den Standardwerten anzuzeigen
    calculateAndDisplayBaseline();
    applyCostItemStyling(); // Also call styling on initial load
    
    // Initialisiere die Anzeige der Gehaltsnebenkosten für beide Szenarien
    const employerCostsDisplay = document.getElementById('employer-social-costs-display');
    if (employerCostsDisplay) {
        employerCostsDisplay.textContent = formatPercentage(EMPLOYER_SOCIAL_COSTS_PERCENT * 100);
    }
    const employerCostsDisplayNE = document.getElementById('employer-social-costs-display-ne');
    if (employerCostsDisplayNE) {
        employerCostsDisplayNE.textContent = formatPercentage(EMPLOYER_SOCIAL_COSTS_PERCENT * 100);
    }

    // Event-Listener für die Szenario-Checkboxen
    document.querySelectorAll('#scenario-selection input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const scenarioId = this.dataset.scenario;
            const scenarioSection = document.getElementById(`scenario-${scenarioId.replace('_', '-')}`);
            
            if (this.checked) {
                scenarioSection.classList.remove('hidden');
                activeScenarios.add(scenarioId);
                // Trigger initial calculation when a scenario section is made visible
                if (scenarioId === 'growth_personnel') calculateGrowthPersonnel();
                if (scenarioId === 'new_employee') calculateNewEmployeeCost();
            } else {
                scenarioSection.classList.add('hidden');
                activeScenarios.delete(scenarioId);
            }
        });
    });
});


function getBaselineInputs() {
    return {
        umsatz: cleanNumberForCalculation(document.getElementById('umsatz_ist').value) || 0,
        wareneinsatz: cleanNumberForCalculation(document.getElementById('wareneinsatz_ist').value) || 0,
        personalkosten: cleanNumberForCalculation(document.getElementById('personalkosten_ist').value) || 0,
        raumkosten: cleanNumberForCalculation(document.getElementById('raumkosten_ist').value) || 0,
        werbekosten: cleanNumberForCalculation(document.getElementById('werbekosten_ist').value) || 0,
        sonstige_betriebliche_aufwendungen: cleanNumberForCalculation(document.getElementById('sonstige_betriebliche_aufwendungen_ist').value) || 0,
        abschreibungen: cleanNumberForCalculation(document.getElementById('abschreibungen_ist').value) || 0,
        finanzierungskosten: cleanNumberForCalculation(document.getElementById('finanzierungskosten_ist').value) || 0,
        current_employees: parseInt(document.getElementById('current_employees').value) || 0,
        ertragsteuersatz: parseFloat(document.getElementById('ertragsteuersatz_ist').value) || 0
    };
}

function calculateAndDisplayBaseline() {
    const form = document.getElementById('baseline-form');
    if (!form.checkValidity()) {
        form.reportValidity();
        document.getElementById('baseline-pnl-summary').style.display = 'none';
        document.getElementById('calculate-scenario').disabled = true;
        return;
    }

    const inputs = getBaselineInputs();

    for (const key in inputs) {
        if (typeof inputs[key] === 'number' && isNaN(inputs[key])) {
            document.getElementById('baseline-pnl-summary').innerHTML = '<p style="color: red;">Bitte gültige Zahlen in allen Feldern eingeben.</p>';
            document.getElementById('baseline-pnl-summary').style.display = 'block';
            document.getElementById('calculate-scenario').disabled = true;
            return;
        }
    }

    baselinePnl = { ...inputs };
    baselinePnl = calculateDerivedPnl(baselinePnl, inputs.ertragsteuersatz);

    const summaryBox = document.getElementById('baseline-pnl-summary');
    summaryBox.innerHTML = `
        <h3>Erfolgsrechnung Zusammenfassung:</h3>
        <p><strong>Umsatz:</strong> ${formatCurrency(baselinePnl.umsatz)}</p>
        <p><strong>Rohertrag:</strong> ${formatCurrency(baselinePnl.rohertrag)}</p>
        <p><strong>Ergebnis vor Steuern (EBT):</strong> ${formatCurrency(baselinePnl.ebt)}</p>
        <p><strong>EBT-Marge:</strong> ${formatPercentage((baselinePnl.ebt / baselinePnl.umsatz) * 100)}</p>
        <p><strong>Ergebnis nach Steuern:</strong> ${formatCurrency(baselinePnl.ergebnis_nach_steuern)}</p>
        <p><strong>Jahresüberschuss-Marge:</strong> ${formatPercentage((baselinePnl.ergebnis_nach_steuern / baselinePnl.umsatz) * 100)}</p>        
    `;
    summaryBox.style.display = 'block';

    document.querySelectorAll('#scenario-selection input[type="checkbox"]').forEach(el => el.disabled = false);
    document.getElementById('calculate-scenario').disabled = false;

    // Dies stellt sicher, dass Szenarien, die von Baseline-Werten abhängen (wie Umsatz pro Mitarbeiter), aktualisiert werden.
    calculateGrowthPersonnel();
    calculateNewEmployeeCost(); // Falls dieses Szenario auch von Baseline-Werten abhängt
}

// -----------------------------------------------------------
// 4. Scenario Management (Dynamic Input Generation & Tracking)
// -----------------------------------------------------------

const scenarioInputTemplates = {
    price_adjustment: `
        <h4>Preise anpassen</h4>
        <div class="input-group">
            <label for="pa_price_change">Veränderung des durchschnittlichen Verkaufspreises (%)</label>
            <input type="number" id="pa_price_change" value="0" step="0.1">
        </div>
        <div class="input-group">
            <label for="pa_volume_change">Erwartete Veränderung des Absatzvolumens (%)</label>
            <input type="number" id="pa_volume_change" value="0" step="0.1">
        </div>
    `,
    new_product: `
        <h4>Neues Produkt / Dienstleistung einführen</h4>
        <div class="input-group">
            <label for="np_additional_revenue">Erwarteter zusätzlicher Jahresumsatz (€)</label>
            <input type="number" id="np_additional_revenue" value="0" min="0">
        </div>
        <div class="input-group">
            <label for="np_additional_cogs_type">Zusätzlicher Wareneinsatz / Materialaufwand</label>
            <select id="np_additional_cogs_type">
                <option value="percentage">Als Prozentsatz des zusätzlichen Umsatzes</option>
                <option value="fixed">Als fester Betrag</option>
            </select>
        </div>
        <div class="input-group">
            <label for="np_additional_cogs_value">Wert für zusätzlichen Wareneinsatz</label>
            <input type="number" id="np_additional_cogs_value" value="0" min="0">
        </div>
        <div class="input-group">
            <label for="np_development_costs">Zusätzliche einmalige Entwicklungskosten (€)</label>
            <input type="number" id="np_development_costs" value="0" min="0">
        </div>
        <div class="input-group">
            <label for="np_usage_duration">Nutzungsdauer des Produkts (Jahre, für Abschreibung)</label>
            <input type="number" id="np_usage_duration" value="3" min="1">
        </div>
        <div class="input-group">
            <label for="np_additional_personnel">Zusätzliche jährliche Personalkosten (€)</label>
            <input type="number" id="np_additional_personnel" value="0" min="0">
        </div>
        <div class="input-group">
            <label for="np_additional_marketing">Zusätzliche jährliche Marketingkosten (€)</label>
            <input type="number" id="np_additional_marketing" value="0" min="0">
        </div>
        <div class="input-group">
            <label for="np_additional_other_costs">Zusätzliche sonstige jährliche Kosten (€)</label>
            <input type="number" id="np_additional_other_costs" value="0" min="0">
        </div>
    `,
    marketing_investment: `
        <h4>Marketinginvestitionen planen</h4>
        <div class="input-group">
            <label for="mi_additional_marketing_spend">Zusätzliche jährliche Marketingausgaben (€)</label>
            <input type="number" id="mi_additional_marketing_spend" value="0" min="0">
        </div>
        <div class="input-group">
            <label for="mi_additional_revenue_type">Erwarteter zusätzlicher Umsatz</label>
            <select id="mi_additional_revenue_type">
                <option value="amount">Als fester Betrag (€)</option>
                <option value="percentage_of_spend">Als Prozentsatz der zusätzlichen Marketingausgaben</option>
            </select>
        </div>
        <div class="input-group">
            <label for="mi_additional_revenue_value">Wert für zusätzlichen Umsatz</label>
            <input type="number" id="mi_additional_revenue_value" value="0" min="0">
        </div>
    `,
    new_employee: `
        <h4>Neuen Mitarbeiter einstellen</h4>
        <div class="input-group">
            <label for="ne_num_employees">Anzahl neuer Mitarbeiter</label>
            <input type="number" id="ne_num_employees" value="1" min="1">
        </div>
        <div class="input-group">
            <label for="ne_monthly_salary">Durchschnittliches Bruttomonatsgehalt pro neuem MA (€)</label>
            <input type="number" id="ne_monthly_salary" value="3000" min="0">
        </div>
        <p class="note">Geschätzte Gehaltsnebenkosten Arbeitgeberanteil: ${formatPercentage(EMPLOYER_SOCIAL_COSTS_PERCENT * 100)}</p>
        <div class="input-group">
            <label for="ne_target_ebt_margin">Ziel-EBT-Marge zur Deckung (%) (Optional, für Goal-Seeking)</label>
            <input type="number" id="ne_target_ebt_margin" value="0" min="0" max="100" step="0.1">
        </div>
    `,
    growth_personnel: `
        <h4>Personalbedarf bei Wachstum ermitteln</h4>
        <div class="input-group">
            <label for="gp_target_revenue_growth">Ziel-Umsatzwachstum für nächstes Jahr (%)</label>
            <input type="number" id="gp_target_revenue_growth" value="10" step="0.1">
        </div>
        <div class="input-group">
            <label for="gp_revenue_per_employee">Aktueller Umsatz pro Mitarbeiter (€) (optional, berechnet)</label>
            <input type="number" id="gp_revenue_per_employee" value="0" min="0" disabled>
        </div>
        <div class="input-group">
            <label for="gp_monthly_salary">Durchschnittliches Bruttomonatsgehalt pro neuem MA (€)</label>
            <input type="number" id="gp_monthly_salary" value="3000" min="0">
        </div>
        <p class="note">Geschätzte Gehaltsnebenkosten Arbeitgeberanteil: ${formatPercentage(EMPLOYER_SOCIAL_COSTS_PERCENT * 100)}</p>
    `,
    new_machine: `
        <h4>Neue Maschine / Betriebsausstattung planen</h4>
        <div class="input-group">
            <label for="nm_acquisition_costs">Anschaffungskosten (€)</label>
            <input type="number" id="nm_acquisition_costs" value="50000" min="0">
        </div>
        <div class="input-group">
            <label for="nm_usage_duration">Nutzungsdauer (Jahre)</label>
            <input type="number" id="nm_usage_duration" value="8" min="1">
        </div>
        <div class="input-group">
            <label for="nm_loan_amount">Kreditsumme (€) (Optional)</label>
            <input type="number" id="nm_loan_amount" value="0" min="0">
        </div>
        <div class="input-group">
            <label for="nm_interest_rate">Zinssatz (%) (Optional)</label>
            <input type="number" id="nm_interest_rate" value="0" step="0.1" min="0" max="100">
        </div>
    `,
    new_vehicle: `
        <h4>Neues Fahrzeug (KFZ) anschaffen</h4>
        <div class="input-group">
            <label for="nv_acquisition_costs">Anschaffungskosten (€)</label>
            <input type="number" id="nv_acquisition_costs" value="30000" min="0">
        </div>
        <div class="input-group">
            <label for="nv_usage_duration">Nutzungsdauer (Jahre)</label>
            <input type="number" id="nv_usage_duration" value="6" min="1">
        </div>
        <div class="input-group">
            <label for="nv_loan_amount">Kreditsumme (€) (Optional)</label>
            <input type="number" id="nv_loan_amount" value="0" min="0">
        </div>
        <div class="input-group">
            <label for="nv_interest_rate">Zinssatz (%) (Optional)</label>
            <input type="number" id="nv_interest_rate" value="0" step="0.1" min="0" max="100">
        </div>
        <div class="input-group">
            <label for="nv_km_per_year">Kilometer pro Jahr (km)</label>
            <input type="number" id="nv_km_per_year" value="15000" min="0">
        </div>
        <div class="input-group">
            <label for="nv_cost_per_km">Kosten pro Kilometer (€/km)</label>
            <input type="number" id="nv_cost_per_km" value="0.38" step="0.01" min="0">
        </div>

    `,
    it_infrastructure: `
        <h4>IT-Infrastruktur / Softwarelizenzen investieren</h4>
        <div class="input-group">
            <label for="it_investment_costs">Investitionskosten (einmalig für Hardware/große Softwarelizenzen) (€)</label>
            <input type="number" id="it_investment_costs" value="10000" min="0">
        </div>
        <div class="input-group">
            <label for="it_usage_duration">Nutzungsdauer (Jahre)</label>
            <input type="number" id="it_usage_duration" value="3" min="1">
        </div>
        <div class="input-group">
            <label for="it_annual_subscription_costs">Zusätzliche jährliche Abo-Kosten (SaaS, Cloud-Dienste, Lizenzen) (€)</label>
            <input type="number" id="it_annual_subscription_costs" value="0" min="0">
        </div>
    `,
    cost_optimization: `
        <h4>Kosten optimieren</h4>
        <div class="input-group">
            <label for="co_cost_block">Kostenblock zur Optimierung</label>
            <select id="co_cost_block">
                <option value="wareneinsatz">Wareneinsatz / Materialaufwand</option>
                <option value="personalkosten">Personalkosten</option>
                <option value="raumkosten">Raumkosten</option>
                <option value="werbekosten">Werbekosten</option>
                <option value="sonstige_betriebliche_aufwendungen">Sonstige Betriebliche Aufwendungen</option>
            </select>
        </div>
        <div class="input-group">
            <label for="co_reduction_type">Reduktion um</label>
            <select id="co_reduction_type">
                <option value="percentage">Prozentsatz (%)</option>
                <option value="amount">Absoluter Betrag (€)</option>
            </select>
        </div>
        <div class="input-group">
            <label for="co_reduction_value">Wert der Reduktion</label>
            <input type="number" id="co_reduction_value" value="0" step="0.1">
        </div>
    `,
    revenue_decline: `
        <h4>Umsatzeinbruch / Kundenverlust simulieren</h4>
        <div class="input-group">
            <label for="rd_revenue_decline_percent">Erwarteter Umsatzrückgang (%)</label>
            <input type="number" id="rd_revenue_decline_percent" value="10" min="0" max="100" step="0.1">
        </div>
        <div class="input-group">
            <label for="rd_variable_cost_share">Anteil der variablen Kosten (von Wareneinsatz) die mit Umsatz wegfallen (%)</label>
            <input type="number" id="rd_variable_cost_share" value="80" min="0" max="100" step="0.1">
        </div>
         <div class="input-group">
            <label for="rd_fixed_cost_savings">Spezifische fixe Kostenersparnisse (€) (z.B. Werbekosten)</label>
            <input type="number" id="rd_fixed_cost_savings" value="0" min="0">
        </div>
    `,
    long_term_scaling: `
        <h4>Langfristige Business-Skalierung</h4>
        <div class="input-group">
            <label for="lts_annual_revenue_growth_rate">Jährliche Umsatzwachstumsrate (%)</label>
            <input type="number" id="lts_annual_revenue_growth_rate" value="5" step="0.1">
        </div>
        <div class="input-group">
            <label for="lts_personnel_cost_increase">Jährliche Steigerung Personalkosten pro MA (%) (Optional)</label>
            <input type="number" id="lts_personnel_cost_increase" value="2" step="0.1">
        </div>
        <div class="input-group">
            <label for="lts_room_cost_increase">Jährliche Steigerung Raumkosten (%) (Optional)</label>
            <input type="number" id="lts_room_cost_increase" value="1" step="0.1">
        </div>
        <div class="input-group">
            <label for="lts_num_years">Anzahl der Jahre für die Projektion</label>
            <input type="number" id="lts_num_years" value="3" min="1" max="10">
        </div>
    `
};

function handleScenarioCheckboxChange(event) {
    const scenarioId = event.target.dataset.scenario;
    const container = document.getElementById('scenario-inputs-container');
    const existingInputGroup = document.getElementById(`scenario-input-group-${scenarioId}`);

    if (event.target.checked) {
        if (!existingInputGroup) {
            const div = document.createElement('div');
            div.id = `scenario-input-group-${scenarioId}`;
            div.classList.add('scenario-input-group');
            div.innerHTML = scenarioInputTemplates[scenarioId];
            container.appendChild(div);
            activeScenarios.add(scenarioId);

        }
        // Spezielle Behandlung für die Vorabberechnung des Umsatzes pro Mitarbeiter,
        // falls 'growth_personnel' ausgewählt ist.
        if (scenarioId === 'growth_personnel' && baselinePnl.umsatz && baselinePnl.personalkosten) {
            // Die 3000 und EMPLOYER_SOCIAL_COSTS_PERCENT sollten als Konstanten definiert sein,
            const employeeCount = baselinePnl.personalkosten / (3000 * 12 * (1 + EMPLOYER_SOCIAL_COSTS_PERCENT)); // Grobe Schätzung
            if (employeeCount > 0) {
                 document.getElementById('gp_revenue_per_employee').value = (baselinePnl.umsatz / employeeCount).toFixed(2);
            } else {
                 document.getElementById('gp_revenue_per_employee').value = 0; // Kann nicht berechnet werden, wenn keine Mitarbeiter
            }
        }
    } else {
        if (existingInputGroup) {
            container.removeChild(existingInputGroup);
            activeScenarios.delete(scenarioId);
        }
    }
}

function applyScenarioChanges() {
    // Start with a clean copy of the baseline P&L for the scenario calculation
    scenarioPnl = { ...baselinePnl };

    // Reset goal-seeking specific outputs
    document.getElementById('needed-revenue-output').textContent = '';

    // Iterate through active scenarios and apply their changes
    activeScenarios.forEach(scenarioId => {
        switch (scenarioId) {
            case 'price_adjustment':
                applyPriceAdjustment();
                break;
            case 'new_product':
                applyNewProduct();
                break;
            case 'marketing_investment':
                applyMarketingInvestment();
                break;
            case 'new_employee':
                applyNewEmployee();
                break;
            case 'growth_personnel':
                applyGrowthPersonnel();
                break;
            case 'new_machine':
                applyNewMachine();
                break;
            case 'new_vehicle':
                applyNewVehicle();
                break;
            case 'it_infrastructure':
                applyITInfrastructure();
                break;
            case 'cost_optimization':
                applyCostOptimization();
                break;
            case 'revenue_decline':
                applyRevenueDecline();
                break;
            case 'long_term_scaling':
                // Long-term scaling is handled separately due to multi-year output
                // No direct P&L adjustment here, but data prepared for chart
                break;
        }
    });

    // Re-calculate derived P&L values after all scenario adjustments
    scenarioPnl = calculateDerivedPnl(scenarioPnl, baselinePnl.ertragsteuersatz);
}

function applyPriceAdjustment() {
    const priceChange = parseFloat(document.getElementById('pa_price_change').value) / 100 || 0;
    const volumeChange = parseFloat(document.getElementById('pa_volume_change').value) / 100 || 0;

    const currentUmsatz = scenarioPnl.umsatz; // Use current scenario P&L as base
    const currentWareneinsatz = scenarioPnl.wareneinsatz;

    const umsatzIncr = currentUmsatz * ((1 + priceChange) * (1 + volumeChange) - 1);
    const wareneinsatzIncr = currentWareneinsatz * volumeChange; // Assumes proportional to volume

    scenarioPnl.umsatz += umsatzIncr;
    scenarioPnl.wareneinsatz += wareneinsatzIncr;
}

function applyNewProduct() {
    const additionalRevenue = parseFloat(document.getElementById('np_additional_revenue').value) || 0;
    const additionalCogsType = document.getElementById('np_additional_cogs_type').value;
    const additionalCogsValue = parseFloat(document.getElementById('np_additional_cogs_value').value) || 0;
    const developmentCosts = parseFloat(document.getElementById('np_development_costs').value) || 0;
    const usageDuration = parseFloat(document.getElementById('np_usage_duration').value) || 1;
    const additionalPersonnel = parseFloat(document.getElementById('np_additional_personnel').value) || 0;
    const additionalMarketing = parseFloat(document.getElementById('np_additional_marketing').value) || 0;
    const additionalOtherCosts = parseFloat(document.getElementById('np_additional_other_costs').value) || 0;

    const depreciationIncr = developmentCosts / usageDuration;

    scenarioPnl.umsatz += additionalRevenue;
    if (additionalCogsType === 'percentage') {
        scenarioPnl.wareneinsatz += additionalRevenue * (additionalCogsValue / 100);
    } else { // fixed
        scenarioPnl.wareneinsatz += additionalCogsValue;
    }
    scenarioPnl.personalkosten += additionalPersonnel;
    scenarioPnl.werbekosten += additionalMarketing;
    scenarioPnl.sonstige_betriebliche_aufwendungen += additionalOtherCosts;
    scenarioPnl.abschreibungen += depreciationIncr;
}

function applyMarketingInvestment() {
    const additionalMarketingSpend = parseFloat(document.getElementById('mi_additional_marketing_spend').value) || 0;
    const additionalRevenueType = document.getElementById('mi_additional_revenue_type').value;
    const additionalRevenueValue = parseFloat(document.getElementById('mi_additional_revenue_value').value) || 0;

    let revenueIncr = 0;
    if (additionalRevenueType === 'amount') {
        revenueIncr = additionalRevenueValue;
    } else { // percentage_of_spend
        revenueIncr = additionalMarketingSpend * (additionalRevenueValue / 100);
    }

    const wareneinsatzRatio = baselinePnl.wareneinsatz / baselinePnl.umsatz; // Use baseline ratio for new revenue
    const wareneinsatzIncr = wareneinsatzRatio * revenueIncr;

    scenarioPnl.werbekosten += additionalMarketingSpend;
    scenarioPnl.umsatz += revenueIncr;
    scenarioPnl.wareneinsatz += wareneinsatzIncr;
}

function applyNewEmployee() {
    const numEmployees = parseFloat(document.getElementById('ne_num_employees').value) || 0;
    const monthlySalary = parseFloat(document.getElementById('ne_monthly_salary').value) || 0;
    const targetEbtMargin = parseFloat(document.getElementById('ne_target_ebt_margin').value) / 100 || 0;

    const personnelCostsIncr = numEmployees * monthlySalary * 12 * (1 + EMPLOYER_SOCIAL_COSTS_PERCENT);
    scenarioPnl.personalkosten += personnelCostsIncr;

    if (targetEbtMargin > 0) {
        const neededRevenue = personnelCostsIncr / targetEbtMargin;
        document.getElementById('goal-seeking-output').classList.remove('hidden');
        document.getElementById('needed-revenue-output').textContent = `Nötiger zusätzlicher Umsatz zur Deckung der neuen Personalkosten bei ${formatPercentage(targetEbtMargin * 100)} EBT-Marge: ${formatCurrency(neededRevenue)}`;
    }
}

function applyGrowthPersonnel() {
    const targetRevenueGrowth = parseFloat(document.getElementById('gp_target_revenue_growth').value) / 100 || 0;
    let revenuePerEmployee = parseFloat(document.getElementById('gp_revenue_per_employee').value) || 0;
    const monthlySalary = parseFloat(document.getElementById('gp_monthly_salary').value) || 0;

    if (revenuePerEmployee === 0 && baselinePnl.umsatz > 0 && baselinePnl.personalkosten > 0) {
         // Fallback calculation if not set, assumes average employee cost
        const estNumEmployees = baselinePnl.personalkosten / (2500 * 12 * (1 + EMPLOYER_SOCIAL_COSTS_PERCENT)); // Rough estimate
        if (estNumEmployees > 0) {
            revenuePerEmployee = baselinePnl.umsatz / estNumEmployees;
        }
    }
    // If still 0, we can't calculate personnel needs for growth
    if (revenuePerEmployee === 0) return;


    const additionalRevenueThroughGrowth = baselinePnl.umsatz * targetRevenueGrowth;
    const personnelCostsIncr = monthlySalary * 12 * (1 + EMPLOYER_SOCIAL_COSTS_PERCENT);

    scenarioPnl.umsatz += additionalRevenueThroughGrowth;
    scenarioPnl.personalkosten += personnelCostsIncr;

    // Wareneinsatz would likely also increase with revenue growth
    const wareneinsatzRatio = baselinePnl.wareneinsatz / baselinePnl.umsatz;
    scenarioPnl.wareneinsatz += additionalRevenueThroughGrowth * wareneinsatzRatio;
}

function applyNewMachine() {
    const acquisitionCosts = parseFloat(document.getElementById('nm_acquisition_costs').value) || 0;
    const usageDuration = parseFloat(document.getElementById('nm_usage_duration').value) || 1;
    const loanAmount = parseFloat(document.getElementById('nm_loan_amount').value) || 0;
    const interestRate = parseFloat(document.getElementById('nm_interest_rate').value) / 100 || 0;

    const depreciationIncr = acquisitionCosts / usageDuration;
    let financingCostsIncr = 0;
    if (loanAmount > 0 && interestRate > 0) {
        financingCostsIncr = (loanAmount / 2) * interestRate; // Simplified average interest over loan term
    }

    scenarioPnl.abschreibungen += depreciationIncr;
    scenarioPnl.finanzierungskosten += financingCostsIncr;
}

function applyNewVehicle() {
    const acquisitionCosts = parseFloat(document.getElementById('nv_acquisition_costs').value) || 0;
    const usageDuration = parseFloat(document.getElementById('nv_usage_duration').value) || 1;
    const loanAmount = parseFloat(document.getElementById('nv_loan_amount').value) || 0;
    const interestRate = parseFloat(document.getElementById('nv_interest_rate').value) / 100 || 0;

    // --- NEW: Calculate additionalOperatingCosts from km/year and €/km ---
    const kmPerYear = parseFloat(document.getElementById('nv_km_per_year').value) || 0;
    const costPerKm = parseFloat(document.getElementById('nv_cost_per_km').value) || 0;
    const additionalOperatingCosts = kmPerYear * costPerKm;
    // --- END NEW ---

    const depreciationIncr = acquisitionCosts / usageDuration;
    let financingCostsIncr = 0;
    if (loanAmount > 0 && interestRate > 0) {
        financingCostsIncr = (loanAmount / 2) * interestRate; // Simplified average interest over loan term
    }

    scenarioPnl.abschreibungen += depreciationIncr;
    scenarioPnl.finanzierungskosten += financingCostsIncr;
    scenarioPnl.sonstige_betriebliche_aufwendungen += additionalOperatingCosts; // This line remains the same, but 'additionalOperatingCosts' is now calculated differently
}

function applyITInfrastructure() {
    const investmentCosts = parseFloat(document.getElementById('it_investment_costs').value) || 0;
    const usageDuration = parseFloat(document.getElementById('it_usage_duration').value) || 1;
    const annualSubscriptionCosts = parseFloat(document.getElementById('it_annual_subscription_costs').value) || 0;

    const depreciationIncr = investmentCosts / usageDuration;

    scenarioPnl.abschreibungen += depreciationIncr;
    scenarioPnl.sonstige_betriebliche_aufwendungen += annualSubscriptionCosts;
}

function applyCostOptimization() {
    const costBlockId = document.getElementById('co_cost_block').value;
    const reductionType = document.getElementById('co_reduction_type').value;
    const reductionValue = parseFloat(document.getElementById('co_reduction_value').value) || 0;

    let reductionAmount = 0;
    if (reductionType === 'percentage') {
        reductionAmount = scenarioPnl[costBlockId] * (reductionValue / 100);
    } else { // amount
        reductionAmount = reductionValue;
    }

    scenarioPnl[costBlockId] -= reductionAmount;
}

function applyRevenueDecline() {
    const revenueDeclinePercent = parseFloat(document.getElementById('rd_revenue_decline_percent').value) / 100 || 0;
    const variableCostShare = parseFloat(document.getElementById('rd_variable_cost_share').value) / 100 || 0;
    const fixedCostSavings = parseFloat(document.getElementById('rd_fixed_cost_savings').value) || 0;

    const umsatzIncr = - (baselinePnl.umsatz * revenueDeclinePercent); // Based on baseline
    const wareneinsatzRatio = baselinePnl.wareneinsatz / baselinePnl.umsatz;
    const wareneinsatzIncr = umsatzIncr * wareneinsatzRatio * variableCostShare;

    scenarioPnl.umsatz += umsatzIncr;
    scenarioPnl.wareneinsatz += wareneinsatzIncr;
    scenarioPnl.werbekosten -= fixedCostSavings; // Example: assuming fixed cost savings apply to marketing
}

// -----------------------------------------------------------
// 5. Main Scenario Calculation & Rendering Trigger
// -----------------------------------------------------------

function calculateScenarioPnl() {
    console.log("--- calculateScenarioPnl START ---");
    if (Object.keys(baselinePnl).length === 0) {
        alert('Bitte berechne zuerst die Baseline-Werte!');
        return;
    }

    // Apply all active scenario changes
    applyScenarioChanges();

    // Render output
    renderPnlComparisonTable();
    renderKeyMetrics();
    renderCharts();

    document.getElementById('results-output').classList.remove('hidden');
    console.log("--- calculateScenarioPnl END ---");
}


// -----------------------------------------------------------
// 6. Output Rendering (Tables & Charts) - ANGEPASST FÜR DYNAMISCHE SKALEN
// -----------------------------------------------------------

function renderPnlComparisonTable() {
    const tableBody = document.querySelector('#pnl-comparison-table tbody');
    tableBody.innerHTML = ''; // Clear previous rows

    // List of cost item names (moved here for direct use)
    const trueCostItems = [ // These are the items that should get the 'cost-item' class
        "Wareneinsatz / Materialaufwand",
        "Personalkosten",
        "Raumkosten",
        "Werbekosten",
        "Sonstige Betriebliche Aufwendungen",
        "Abschreibungen",
        "Finanzierungskosten (Zinsen)" // Ensure this matches the label from pnlLineItems
    ];

    pnlLineItems.forEach(item => {
        const baselineValue = baselinePnl[item.id] || 0;
        const scenarioValue = scenarioPnl[item.id] || 0;
        const change = scenarioValue - baselineValue;
        const percentageChange = baselineValue !== 0 ? (change / baselineValue) * 100 : 0;

        const row = tableBody.insertRow();

        // Determine if this is a cost item for applying the 'cost-item' class
        const isCostItem = trueCostItems.some(costItemLabel => item.label.startsWith(costItemLabel));

        if (isCostItem) {
            row.classList.add('cost-item');
            console.log(`Added 'cost-item' class to row for: ${item.label}`); // Debugging
        }

        row.innerHTML = `
            <td>${item.label}</td>
            <td>${formatCurrency(baselineValue)}</td>
            <td>${formatCurrency(scenarioValue)}</td>
            <td class="${change > 0 ? 'positive' : (change < 0 ? 'negative' : '')}">${formatCurrency(change)}</td>
            <td class="${percentageChange > 0 ? 'positive' : (percentageChange < 0 ? 'negative' : '')}">${formatPercentage(percentageChange)}</td>
        `;
    });
}

function renderKeyMetrics() {
    const summaryBox = document.getElementById('key-metrics-summary');
    const baselineEbtMargin = (baselinePnl.ebt / baselinePnl.umsatz) * 100;
    const scenarioEbtMargin = (scenarioPnl.ebt / scenarioPnl.umsatz) * 100;

    summaryBox.innerHTML = `
        <p><strong>Umsatzrendite (EBT-Marge) Baseline:</strong> ${formatPercentage(baselineEbtMargin)}</p>
        <p><strong>Umsatzrendite (EBT-Marge) Neu:</strong> ${formatPercentage(scenarioEbtMargin)}</p>
        <p><strong>Gewinn pro Umsatz (€):</strong> ${formatCurrency(scenarioPnl.ergebnis_nach_steuern / scenarioPnl.umsatz)} (Neu)</p>
    `;
}

function renderCharts() {
    console.log("renderCharts START");
    destroyCharts(); // Clear existing charts

    hideAllChartContainers(); // Hide all chart containers first

    // Helper function to calculate min/max with a small buffer for dynamic scales
    function calculateMinMax(dataValues) {
        if (dataValues.length === 0) return { min: 0, max: 100 }; // Default if no data
        const minVal = Math.min(...dataValues);
        const maxVal = Math.max(...dataValues);

        if (minVal === maxVal) { // Handle cases where all values are the same
            return { min: minVal * 0.9, max: maxVal * 1.1 };
        }

        const buffer = (maxVal - minVal) * 0.1; // 10% buffer
        let calculatedMin = minVal - buffer;
        let calculatedMax = maxVal + buffer;

        // Ensure that if values are positive, min is not less than 0 or is very close to 0 if values are small
        if (minVal >= 0 && calculatedMin < 0) {
            calculatedMin = 0; // If all values are positive, it often makes sense to start at 0
        }
        // If minVal is negative, allow negative scale
        // If the difference is very small, ensure a visible range
        if (maxVal - minVal < Math.abs(maxVal * 0.01)) { // If difference is less than 1% of max value
             calculatedMin = minVal * 0.9;
             calculatedMax = maxVal * 1.1;
        }

        return { min: calculatedMin, max: calculatedMax };
    }


    // --- Umsatzentwicklung ---
    document.getElementById('umsatz-chart-box').classList.remove('hidden');
    const umsatzCtx = document.getElementById('umsatzChart').getContext('2d');
    const umsatzData = [baselinePnl.umsatz, scenarioPnl.umsatz];
    const umsatzScale = calculateMinMax(umsatzData);

    myCharts.umsatzChartInstance = new Chart(umsatzCtx, {
        type: 'bar',
        data: {
            labels: [''],
            datasets: [
                {
                    label: 'Basis',
                    data: [umsatzData[0]],
                    backgroundColor: '#008cba'
                },
                {
                    label: 'Simuliert',
                    data: [umsatzData[1]],
                    backgroundColor: '#cdf9ff'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false, // WICHTIG: beginAtZero auf false setzen
                    min: umsatzScale.min, // Dynamischer Minimalwert
                    max: umsatzScale.max, // Dynamischer Maximalwert
                    title: {
                        display: true,
                    },
                     ticks: {
                        callback: function(value) { // Formatierung für Achsenbeschriftungen
                            return formatCurrency(value);
                        }
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                },
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    formatter: function(value) {
                        return formatCurrency(value);
                    },
                    color: '#333'
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    // --- Gewinnentwicklung ---
    document.getElementById('gewinn-chart-box').classList.remove('hidden');
    const gewinnCtx = document.getElementById('gewinnChart').getContext('2d');
    const gewinnData = [baselinePnl.ergebnis_nach_steuern, scenarioPnl.ergebnis_nach_steuern];
    const gewinnScale = calculateMinMax(gewinnData);

    myCharts.gewinnChartInstance = new Chart(gewinnCtx, {
        type: 'bar',
        data: {
            labels: [''],
            datasets: [
                {
                    label: 'Basis',
                    data: [gewinnData[0]],
                    backgroundColor: '#008cba'
                },
                {
                    label: 'Simuliert',
                    data: [gewinnData[1]],
                    backgroundColor: '#cdf9ff'
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: false, // WICHTIG: beginAtZero auf false setzen
                    min: gewinnScale.min, // Dynamischer Minimalwert
                    max: gewinnScale.max, // Dynamischer Maximalwert
                    title: {
                        display: true,
                    },
                     ticks: {
                        callback: function(value) { // Formatierung für Achsenbeschriftungen
                            return formatCurrency(value);
                        }
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                },
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    formatter: function(value) {
                        return formatCurrency(value);
                    },
                    color: '#333'
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    // Cost Structure (Pie Chart) - remains largely unchanged for pie charts

    const costLabels = ['Wareneinsatz', 'Personalkosten', 'Raumkosten', 'Werbekosten', 'S. Betriebl. Aufwendungen', 'Abschreibungen', 'Finanzierungskosten'];

    const baselineCosts = [
        baselinePnl.wareneinsatz, baselinePnl.personalkosten, baselinePnl.raumkosten,
        baselinePnl.werbekosten, baselinePnl.sonstige_betriebliche_aufwendungen,
        baselinePnl.abschreibungen, baselinePnl.finanzierungskosten
    ];

    if (baselineCosts.some(c => c > 0) || scenarioCosts.some(c => c > 0)) {

        document.getElementById('cost-structure-chart-box').classList.remove('hidden');
        const costStructureCtx = document.getElementById('costStructureChart').getContext('2d');
        myCharts.costStructureChartInstance = new Chart(costStructureCtx, {
            type: 'pie',
            data: {
                labels: costLabels,
                datasets: [{
                    label: 'Basis Kostenanteile',
                    data: baselineCosts,
                    backgroundColor: [
                        '#2ac9c4', '#0f7476', '#18cef8', '#008cba', '#105a7a', '#5fe9e1', '#042c2f'
                    ],
                    hoverOffset: 4
                }]

            },

            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Kostenstruktur im Vergleich'
                    },
                    legend: {
                        display: true,
                        position: 'top', // Oder 'top', 'bottom', 'left'
                        labels: {
                            color: '#ffffff',
                            boxWidth: 20,
                            padding: 15,
                            align: 'start', // <-- Dies richtet die Legenden-Items linksbündig aus
                        }
                    },
                    tooltip: {
                        // Wichtige Anpassung hier für Tooltip!
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                const value = context.parsed;
                                const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                const percentage = (value / total * 100).toFixed(1);

                                // Zeigt Label, Währungswert und Prozentsatz an
                                return `${label}${formatCurrency(value)} (${percentage}%)`;
                            }
                        }

                    },

                    datalabels: {

                        formatter: (value, ctx) => {
                            // Berechnung des Prozentsatzes wie gehabt
                            let sum = 0;
                            let dataArr = ctx.chart.data.datasets[0].data;
                            dataArr.map(data => {
                                sum += data;
                            });
                            let percentage = (value * 100 / sum).toFixed(1); // Kein "%" hier, da wir es später hinzufügen können, wenn nötig

                            // Optional: Wenn der Wert zu klein ist (z.B. unter 1%), kein Label anzeigen
                            // Schwellenwert anpassen, z.B. 0.5 für 0.5%
                            if (value * 100 / sum < 1.0) { // Beispiel: Zeige keine Prozente unter 1%
                                return ''; // Label wird ausgeblendet
                            }
                            return percentage + "%"; // Prozentsatz mit %-Zeichen

                        },
                        color: '#fff',
                        display: 'auto', // WICHTIG: Zeigt Labels nur an, wenn genügend Platz ist
                        align: 'center', // Versuch, das Label mittig im Segment zu platzieren
                        font: {
                            size: 9, // Kann bei sehr kleinen Segmenten helfen
                        }
                    }
                }
            },
            plugins: [ChartDataLabels]

        });
    }

    // --- Scenario-specific charts ---

    // Langfristige Skalierung: Deine Finanzen im Jahresverlauf
if (activeScenarios.has('long_term_scaling')) {
    document.getElementById('long-term-scaling-chart-box').classList.remove('hidden');
    const annualGrowthRate = parseFloat(document.getElementById('lts_annual_revenue_growth_rate').value) / 100 || 0;
    const personnelCostIncrease = parseFloat(document.getElementById('lts_personnel_cost_increase').value) / 100 || 0;
    const roomCostIncrease = parseFloat(document.getElementById('lts_room_cost_increase').value) / 100 || 0;
    const numYears = parseInt(document.getElementById('lts_num_years').value) || 3;

    const years = [];
    const projectedUmsatz = [];
    const projectedEbt = [];
    const projectedProfit = [];

    let currentYearPnl = { ...baselinePnl };

    for (let i = 0; i <= numYears; i++) {
        let yearLabel = `Jahr ${i}`;
        if (i === 0) {
            yearLabel = 'Basisjahr';
        } else {
            // Apply growth and cost increases
            currentYearPnl.umsatz *= (1 + annualGrowthRate);
            currentYearPnl.wareneinsatz *= (1 + annualGrowthRate); // Simplified: Wareneinsatz grows with Umsatz
            currentYearPnl.personalkosten *= (1 + personnelCostIncrease);
            currentYearPnl.raumkosten *= (1 + roomCostIncrease);
            // Other costs remain constant for simplicity in this example
            currentYearPnl = calculateDerivedPnl(currentYearPnl, baselinePnl.ertragsteuersatz);
        }

        years.push(yearLabel);
        projectedUmsatz.push(currentYearPnl.umsatz);
        projectedEbt.push(currentYearPnl.ebt);
        projectedProfit.push(currentYearPnl.ergebnis_nach_steuern);
    }

    const longTermScalingCtx = document.getElementById('longTermScalingChart').getContext('2d');

    // Berechne Min/Max für die sekundäre Skala (EBT und Ergebnis nach Steuern)
    const secondaryScaleValues = [...projectedEbt, ...projectedProfit];
    const secondaryScale = calculateMinMax(secondaryScaleValues);

    if (myCharts.longTermScalingChartInstance) {
        myCharts.longTermScalingChartInstance.destroy();
    }

    myCharts.longTermScalingChartInstance = new Chart(longTermScalingCtx, {
        type: 'line',
        data: {
            labels: years,
            datasets: [
                {
                    label: 'Umsatz',
                    data: projectedUmsatz,
                    borderColor: '#15b784',
                    fill: false,
                    tension: 0.1,
                    yAxisID: 'y' // Zuweisung zur ersten Y-Achse
                },
                {
                    label: 'EBT',
                    data: projectedEbt,
                    borderColor: '#18cef8',
                    fill: false,
                    tension: 0.1,
                    yAxisID: 'y1' // Zuweisung zur zweiten Y-Achse
                },
                {
                    label: 'Ergebnis nach Steuern',
                    data: projectedProfit,
                    borderColor: '#ebfeff',
                    fill: false,
                    tension: 0.1,
                    yAxisID: 'y1' // Zuweisung zur zweiten Y-Achse
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { // Erste Y-Achse für Umsatz
                    type: 'linear',
                    position: 'left',
                    beginAtZero: false,
                    title: {
                        display: true,
                        text: 'Umsatz (€)'
                    },
                    ticks: {
                        callback: function(value) {
                            return formatCurrency(value);
                        }
                    }
                },
                y1: { // Zweite Y-Achse für EBT und Ergebnis nach Steuern
                    type: 'linear',
                    position: 'right', // Position auf der rechten Seite
                    beginAtZero: false,
                    min: secondaryScale.min, // Dynamischer Minimalwert für die zweite Skala
                    max: secondaryScale.max, // Dynamischer Maximalwert für die zweite Skala
                    title: {
                        display: true,
                        text: 'EBT / Ergebnis nach Steuern (€)'
                    },
                    grid: {
                        drawOnChartArea: false // Wichtig: Gitterlinien nur auf der linken Achse anzeigen
                    },
                    ticks: {
                        callback: function(value) {
                            return formatCurrency(value);
                        }
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Jahr'
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'Langfristige Skalierung: Deine Finanzen im Jahresverlauf'
                },
                datalabels: {
                    display: false
                }
            }
        },
        plugins: [ChartDataLabels]
    });
}

// Goal-seeking output visibility handled by individual scenario functions
console.log("renderCharts END");
}

// -----------------------------------------------------------
// 7. Event Listeners
// -----------------------------------------------------------

document.addEventListener('DOMContentLoaded', () => {
    // Initial state: disable scenario selection and scenario calculation until baseline is calculated
    // All checkboxes and the 'calculate-scenario' button should be disabled initially
    document.querySelectorAll('#scenario-selection input[type="checkbox"]').forEach(el => el.disabled = true);
    document.getElementById('calculate-scenario').disabled = true;

    // Initially hide the baseline summary box
    document.getElementById('baseline-pnl-summary').style.display = 'none';


    // Event listener for the "Baseline berechnen" button
    const calculateBaselineBtn = document.getElementById('calculate-baseline');
    if (calculateBaselineBtn) {
        calculateBaselineBtn.addEventListener('click', calculateAndDisplayBaseline);
    } else {
        console.error("Element mit ID 'calculate-baseline' nicht gefunden!");
    }

    // Event listener for the "Szenario(s) simulieren" button
 const calculateScenarioBtn = document.getElementById('calculate-scenario');
if (calculateScenarioBtn) {
    calculateScenarioBtn.addEventListener('click', (event) => {
        event.preventDefault();
        calculateScenarioPnl();
    });
}

    // Add listeners to scenario checkboxes to dynamically show/hide input fields
    document.querySelectorAll('.scenario-category input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', handleScenarioCheckboxChange);
    });

    // Event listener for the "Neue Simulation starten" button
    document.getElementById('reset-simulation').addEventListener('click', () => {
        // Reset all inputs
        document.getElementById('baseline-form').reset();
        document.querySelectorAll('#scenario-selection input[type="checkbox"]').forEach(checkbox => {
            checkbox.checked = false;
            checkbox.disabled = true; // Disable until new baseline
        });
        document.getElementById('calculate-scenario').disabled = true; // Disable scenario button after reset

        document.getElementById('baseline-pnl-summary').innerHTML = '';
        document.getElementById('baseline-pnl-summary').style.display = 'none'; // Hide summary

        document.getElementById('scenario-inputs-container').innerHTML = '';
        activeScenarios.clear();

        document.getElementById('results-output').classList.add('hidden'); // Hide results
        destroyCharts();
        hideAllChartContainers();
        document.getElementById('pnl-comparison-table tbody').innerHTML = '';
        document.getElementById('key-metrics-summary').innerHTML = '';
        document.getElementById('goal-seeking-output').classList.add('hidden');

        baselinePnl = {}; // Clear baseline data
        scenarioPnl = {}; // Clear scenario data
    });

    // Initial baseline calculation on load with default values (optional, but good for demo)
    calculateAndDisplayBaseline();
});
 </script>
  
</body>
</html>
